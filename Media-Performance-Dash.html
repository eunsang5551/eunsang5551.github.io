<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<title>ì–¸ë¡ ì‚¬/ê¸°ì ì¢…í•© KPI ì°¨íŠ¸</title>

<style>
  #chartdiv {
    width: 100%;
    height: 650px;
  }
</style>

<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
</head>
<body>

<div id="chartdiv"></div>

<script>
am5.ready(async function () {

  let chartData = [];
  let avgValue = 0;

  try {
    console.log("ğŸ“¡ KPI API í˜¸ì¶œ ì‹œë„...");
    const res = await fetch("http://dev-web-api.newssalad.com:8083/api/performance/summary");
    
    if (!res.ok) throw new Error("API ì‘ë‹µ ì—ëŸ¬: " + res.status);

    const result = await res.json();
    console.log("âœ… API ì‘ë‹µ:", result);

    avgValue = result.avgValue || 0;

    chartData = result.items.map(item => ({
      name: item.name,
      steps: item.score,
      ratio: item.ratio,
      diff: item.diff,
      pictureSettings: {
        src: item.imageUrl || "https://www.amcharts.com/wp-content/uploads/2019/04/monica.jpg"
      }
    }));

  } catch (err) {
    console.error("âŒ API í˜¸ì¶œ ì‹¤íŒ¨", err);
    console.warn("â¡ï¸ ë”ë¯¸ ë°ì´í„°ë¡œ ì°¨íŠ¸ í‘œì‹œí•©ë‹ˆë‹¤.");

    avgValue = 30000;

    chartData = [
      { name: "ì¡°ì„ ì¼ë³´", steps: 45000, ratio: 130, diff: 15000, pictureSettings:{src:"https://www.amcharts.com/wp-content/uploads/2019/04/ross.jpg"} },
      { name: "ì¤‘ì•™ì¼ë³´", steps: 38000, ratio: 120, diff: 8000, pictureSettings:{src:"https://www.amcharts.com/wp-content/uploads/2019/04/rachel.jpg"} },
      { name: "í•œê²¨ë ˆ", steps: 24000, ratio: 80, diff: -6000, pictureSettings:{src:"https://www.amcharts.com/wp-content/uploads/2019/04/joey.jpg"} }
    ];
  }

  // ======================= CHART =========================
  var root = am5.Root.new("chartdiv");
  root.setThemes([am5themes_Animated.new(root)]);

  var chart = root.container.children.push(
    am5xy.XYChart.new(root, {
      panX: false,
      panY: false,
      paddingLeft: 0,
      paddingRight: 30
    })
  );

  var yAxis = chart.yAxes.push(
    am5xy.CategoryAxis.new(root, {
      categoryField: "name",
      renderer: am5xy.AxisRendererY.new(root, {})
    })
  );

  var xAxis = chart.xAxes.push(
    am5xy.ValueAxis.new(root, {
      min: 0,
      renderer: am5xy.AxisRendererX.new(root, {})
    })
  );

  var series = chart.series.push(
    am5xy.ColumnSeries.new(root, {
      name: "ì¢…í•© KPI",
      xAxis: xAxis,
      yAxis: yAxis,
      valueXField: "steps",
      categoryYField: "name",
      tooltip: am5.Tooltip.new(root, {
        labelText:
          "{name}\nKPI: {valueX}\ní‰ê·  ëŒ€ë¹„: {ratio}%\nì°¨ì´: {diff}\nì „ì²´ í‰ê· : " + avgValue
      })
    })
  );

  series.columns.template.setAll({
    cornerRadiusTR: 10,
    cornerRadiusBR: 10,
    fillOpacity: 0.9
  });

  var circleTemplate = am5.Template.new({});

  series.bullets.push(function (root, series, dataItem) {
    var container = am5.Container.new(root,{});
    var circle = container.children.push(am5.Circle.new(root,{radius:34},circleTemplate));
    var mask = container.children.push(am5.Circle.new(root,{radius:27}));

    var imgBox = container.children.push(
      am5.Container.new(root,{ mask })
    );

    imgBox.children.push(
      am5.Picture.new(root,{
        templateField:"pictureSettings",
        centerX: am5.p50,
        centerY: am5.p50,
        width:60,
        height:60
      })
    );

    return am5.Bullet.new(root,{ sprite:container });
  });

  series.set("heatRules", [{
    dataField: "valueX",
    min: am5.color(0xe5dc36),
    max: am5.color(0x5faa46),
    target: series.columns.template,
    key: "fill"
  }]);

  series.data.setAll(chartData);
  yAxis.data.setAll(chartData);

  series.appear();
  chart.appear(1000, 100);

});
</script>
</body>
</html>
